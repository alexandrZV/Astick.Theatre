"use strict";(function(){var t=function(n){var t=document.createElement("div");return t.innerHTML=n,t.firstChild.cloneNode(!0)},n=function n(t){this.el_Element=t;this.el_Element$=$(this.el_Element);this.m_Disabled=!1;this.options={};var i=this.el_Element$.data();i.searchMinLength===undefined&&i.searchMethod==="local"&&(i.searchMinLength=0);this.options=$.fn.extend(this.options,n.DEFAULTS,i);this.m_EnabledHiddensElements=!0;this.options.fieldKey!==undefined&&this.options.fieldName!==undefined?(this.m_FieldKey=this.options.fieldKey,this.m_FieldName=this.options.fieldName):(this.options.fieldKey===undefined&&(this.m_FieldKey=this.options.fieldItemKey!==undefined?this.options.fieldKey=this.options.fieldItemKey:"key"),this.options.fieldName===undefined&&(this.m_FieldName=this.options.fieldItemValue!==undefined?this.options.fieldName=this.options.fieldItemValue:"value"),this.m_EnabledHiddensElements=!1);this.options.fieldValue===undefined&&(this.options.fieldValue=this.options.fieldItemValue!==undefined?this.options.fieldItemValue:this.m_FieldName);this.m_FieldItemKey=this.options.fieldItemKey!==undefined?this.options.fieldItemKey:this.m_FieldKey;this.m_FieldItemValue=this.options.fieldItemValue!==undefined?this.options.fieldItemValue:this.m_FieldName;this.f_Init()};window.MaterialSelectfield=n;n.DEFAULTS={minWidth:50,sortName:"",sortOrder:"asc",searchUrl:undefined,searchMinLength:3,searchLimit:15,searchMethod:"get",searchCache:!0,readOnly:!1,fieldKey:undefined,fieldName:undefined,fieldValue:undefined,fieldValueTemplate:undefined,fieldItemKey:undefined,fieldItemValue:undefined,fieldItemValueTemplate:undefined,showError:!0,source:undefined};n.prototype.Constant_={};n.prototype.m_FieldKey="id";n.prototype.m_FieldName="name";n.prototype.m_FieldItemKey="key";n.prototype.m_FieldItemValue="value";n.prototype.CssClasses_={LABEL:"mdl-selectfield__label",INPUT:"mdl-selectfield__input",IS_DIRTY:"is-dirty",IS_FOCUSED:"is-focused",IS_DISABLED:"is-disabled",IS_INVALID:"is-invalid",IS_UPGRADED:"is-upgraded",IS_MENU_HIDE:"is-menu_hide",MENU_ITEM:"mdl-menu__item",MENU_SELECT:"mdl-menu__item_active"};n.prototype.f_GetTextFromTemplatyText=function(n,t,i){var r=t,s=i===!0,e=r.match(/\[%.*?%\]/g),f,u,o;if(e!=null)for(f=0;f<e.length;f++)u=e[f].replace(/\[%|%\]/g,""),o=new RegExp("\\[%"+u+"%]","g"),r=s?r.replace(o,Cl_Core.f_Sprintf('<span fld="%s">%s<\/span>',u,Cl_Core.f_GetItemField(n,u))):r.replace(o,Cl_Core.f_GetItemField(n,u));return r};n.prototype.f_IsSearch=function(){return!this.options.readOnly&&(this.options.searchUrl!==undefined||this.options.searchMethod==="local"&&this.p_Data!==undefined&&this.p_Data!==null&&this.p_Data.length>0)};n.prototype.f_GetItemValue=function(n){return this.options.fieldItemValueTemplate!==undefined?this.f_GetTextFromTemplatyText(n,this.options.fieldItemValueTemplate,!1):Cl_Core.f_GetItemField(n,this.m_FieldItemValue)};n.prototype.f_GetKey=function(n){if(this.el_Element)return this.p_Data==null||this.p_Data.length==0?null:n==null||n<0||n>=this.p_Data.length?this.el_Input.getAttribute("key"):Cl_Core.f_GetItemField(this.p_Data[n],this.m_FieldItemKey)};n.prototype.f_GetValue=function(n){return this.options.fieldValueTemplate!==undefined?this.f_GetTextFromTemplatyText(n,this.options.fieldValueTemplate,!1):n===undefined?this.el_Input.value:Cl_Core.f_GetItemField(n,this.options.fieldValue)};n.prototype.f_GetValueFromIndex=function(n){if(this.el_Element)return this.p_Data==null||this.p_Data.length==0?null:n==null||n<0||n>=this.p_Data.length?this.el_Input.value:this.f_GetValue(this.p_Data[n])};n.prototype.f_SetData=function(n){var t=n;t==null&&(t=[]);this.f_ClearItems();t.total!==undefined&&t.rows!==undefined?(this.m_TotalRows=t.total,this.p_Data=t.rows):this.p_Data=t;t.length!==0&&this.f_IsSearch()?this.el_Input.setAttribute("key",""):this.f_SetValue();this.f_InitMenu()};n.prototype.f_GetSelectedKey=function(){var i,t,n;if(this.p_Data!==undefined&&this.p_Data!==null&&this.p_Data.length>0){for(t=this.el_Input.getAttribute("key"),n=0;n<this.p_Data.length;n++)if(Cl_Core.f_GetItemField(this.p_Data[n],this.m_FieldItemKey)==t){i=this.p_Data[n];break}return i===undefined?null:t}return null};n.prototype.f_SetKey=function(n){var t,u,f,r,i,e;if(this.el_Element){if(t=null,n===null||n===undefined||n==="")this.el_Input.value="",this.el_ElementKey!==undefined&&(this.el_ElementKey.value="");else if(this.p_Data!=null){for(u=!1,f=0;f<this.p_Data.length;f++)if(t=this.p_Data[f],Cl_Core.f_GetItemField(t,this.m_FieldItemKey)==n){this.el_Input.value=this.f_GetValue(t);i=Cl_Core.f_GetItemField(t,this.m_FieldItemKey);this.el_Input.setAttribute("key",i);this.el_Input.setAttribute("name",this.m_FieldName);this.el_ElementKey!==undefined&&(this.el_ElementKey.setAttribute("name",this.m_FieldKey),this.el_ElementKey.value=i);u=!0;break}u||(r=parseInt(n),r!==NaN&&this.p_Data.length>r&&(t=this.p_Data[r],this.el_Input.value=t.toString(),i=r,this.el_Input.setAttribute("key",i),this.el_Input.setAttribute("name",this.m_FieldName),this.el_ElementKey!==undefined&&(this.el_ElementKey.setAttribute("name",this.m_FieldKey),this.el_ElementKey.value=i),u=!0));this.el_Input.value!=""?this.el_Element.classList.add(this.CssClasses_.IS_DIRTY):this.el_Element.classList.remove(this.CssClasses_.IS_DIRTY);this.m_Disabled||("createEvent"in document?(e=document.createEvent("HTMLEvents"),e.initEvent("change",!1,!0),this.el_Element.dispatchEvent(e),this.el_Input.dispatchEvent(e)):(this.el_Element.fireEvent("onchange"),this.el_Input.fireEvent("onchange")),this.f_CheckValidity());this.f_IsSearch()&&(t===null?this.options.searchMethod==="local"?this.f_ClearItems():this.f_SetData():(this.m_TotalRows=1,this.m_SearchText=this.el_Input.value,this.options.searchMethod==="local"?this.f_InitMenu([t]):this.f_SetData([t]),this.el_Input.setAttribute("key",n),this.m_EnabledHiddensElements&&(this.el_ElementKey.value=n)))}this.f_CheckValidity()}};n.prototype.f_SetIndex=function(n){this.el_Element&&(this.p_Data==null||n==null||n<0||n>=this.p_Data.length?(this.el_Input.value="",this.f_SetKey()):this.f_SetKey(Cl_Core.f_GetItemField(this.p_Data[n],this.m_FieldItemKey)))};n.prototype.f_SetValue=function(n){var t,r,i,u;if(this.el_Element)if(t=this,n!==undefined&&n!==null){if(this.f_IsSearch())n.length>=this.options.searchMinLength?this.options.searchMethod==="local"?(r=[],t.m_SearchText=t.el_Input.value.toLowerCase(),[].forEach.call(t.p_Data,function(n,i){var u=t.f_GetItemValue(n).toLowerCase(),i=u.indexOf(t.m_SearchText);i>-1&&r.push(n)}),this.m_TotalRows=r.length,this.f_InitMenu(r),this.f_MenuShow()):$.ajax({type:this.options.searchMethod,url:this.options.searchUrl,data:{limit:this.options.searchLimit,sort:this.options.sortName,order:this.options.sortOrder,query:this.el_Input.value},cache:this.options.searchCache,success:function(n){n.rows!==undefined?n.rows.length>0?(t.m_SearchText=t.el_Input.value,t.f_SetData(n),n.rows.length==1?(t.f_SetIndex(0),t.f_MenuHide()):t.f_MenuShow()):(t.f_ClearItems(),t.p_Data=[]):t.f_ShowError("Ошибка запроса!")},error:function(n){var i=n.responseText;i===""?(i="Ошибка запроса!",t.f_ShowError(i)):t.f_ShowError(i)},complete:function(){}}):this.f_ClearItems();else if(this.p_Data!==undefined&&this.p_Data!==null)for(i=0;i<this.p_Data.length;i++)if(this.f_GetValue(this.p_Data[i])===n){u=Cl_Core.f_GetItemField(this.p_Data[i],this.m_FieldItemKey);this.f_SetKey(u);break}}else this.f_SetKey()};n.prototype.f_MenuHide=function(){this.el_MenuContainer!=null&&this.el_MenuContainer.classList.add(this.CssClasses_.IS_MENU_HIDE);this.el_Menu.MaterialMenu.hide()};n.prototype.f_MenuShow=function(){this.el_MenuContainer!=null&&this.el_MenuContainer.classList.remove(this.CssClasses_.IS_MENU_HIDE);this.el_Menu.MaterialMenu.show()};n.prototype.f_OnInputFocus=function(){this.el_Element.classList.add(this.CssClasses_.IS_FOCUSED)};n.prototype.f_OnInputBlur=function(){this.el_Element.classList.remove(this.CssClasses_.IS_FOCUSED);this.p_Data===undefined||this.p_Data===null||this.p_Data.length===0?this.f_SetValue():this.f_GetSelectedKey()===null&&(this.f_IsSearch()?(this.m_SearchText="",this.options.searchMethod!=="local"?this.f_SetData():(this.f_SetValue(),this.f_InitMenu())):this.f_SetValue());this.f_MenuHide()};n.prototype.f_OnInputClick=function(){this.el_MenuContainer!=null&&(!this.m_Disabled&&this.el_MenuContainer.classList.contains(this.CssClasses_.IS_MENU_HIDE)&&this.p_Data!==undefined&&this.p_Data!==null&&this.p_Data.length>0?this.f_MenuShow():this.f_MenuHide())};n.prototype.f_OnInputKey=function(n){var t=this,i;n.keyCode===38?(this.f_SelectItem(-1)||this.el_MenuContainer.classList.contains(this.CssClasses_.IS_MENU_HIDE)||this.f_MenuHide(),n.preventDefault()):n.keyCode===40?(this.el_MenuContainer.classList.contains(this.CssClasses_.IS_MENU_HIDE)?this.f_SelectItem(1)&&this.f_MenuShow():this.f_SelectItem(1),n.preventDefault()):n.keyCode===13?(i=this.el_Menu.querySelectorAll("."+this.CssClasses_.MENU_ITEM),[].forEach.call(i,function(n){if(n.classList.contains(t.CssClasses_.MENU_SELECT))return n.classList.remove(t.CssClasses_.MENU_SELECT),t.f_SetKey(n.getAttribute("key")),!1}),this.f_MenuHide(),n.preventDefault()):n.keyCode===27?t.el_Input.blur():this.options.readOnly&&n.preventDefault()};n.prototype.f_OnInputKeyUp=function(n){n.keyCode!==38&&n.keyCode!==40&&n.keyCode!==13&&this.f_IsSearch()&&this.f_SetValue(this.el_Input.value)};n.prototype.f_Init=function(){var t,r,f,u,e,o,i;if(this.el_Element){if(t=this,this.el_Label=this.el_Element.querySelector("."+this.CssClasses_.LABEL),this.el_Input=this.el_Element.querySelector("."+this.CssClasses_.INPUT),this.el_Input$=$(this.el_Input),this.el_Menu=this.el_Element.querySelector("ul"),this.el_Label==null||this.el_Input==null||this.el_Menu==null)return;if(this.el_Element.classList.contains(this.CssClasses_.IS_DISABLED)&&this.f_SetDisabled(!0),this.el_Element.classList.contains("mdl-selectfield--icon")&&(r=document.createElement("label"),r.innerHTML='<label for="'+this.el_Input.id+'"><i class="mdl-icon-toggle__label material-icons">keyboard_arrow_down<\/i><\/label>',this.el_Element.insertBefore(r,this.el_Label)),this.m_EnabledHiddensElements&&(this.el_ElementKey=document.createElement("input"),this.el_ElementKey.setAttribute("type","hidden"),this.el_Element.insertBefore(this.el_ElementKey,this.el_Input)),this.el_Element.classList.add("mdl-textfield","mdl-js-textfield"),this.el_Element.classList.contains("mdl-selectfield--floating-label")&&this.el_Element.classList.add("mdl-textfield--floating-label"),this.el_Label.classList.add("mdl-textfield__label"),this.el_Input.classList.add("mdl-textfield__input"),this.el_Menu.classList.add("mdl-menu","mdl-menu--bottom-left"),t.el_Element.hasAttribute("disabled")&&this.f_SetDisabled(!0),t.el_Element.hasAttribute("readonly")||componentHandler.upgradeElement(this.el_Menu,"MaterialMenu"),this.el_Element.style.width=this.el_Menu.clientWidth!==undefined&&this.el_Menu.clientWidth>10?this.el_Menu.clientWidth+(this.el_Menu.clientWidth<this.el_Menu.scrollWidth?17:0)+"px":this.options.minWidth+"px",this.el_MenuContainer=this.el_Element.querySelector(".mdl-menu__container"),this.el_MenuContainer!=null&&this.el_MenuContainer.classList.add(this.CssClasses_.IS_MENU_HIDE),this.e_InputFocus=this.f_OnInputFocus.bind(this),this.e_InputBlur=this.f_OnInputBlur.bind(this),this.e_InputClick=this.f_OnInputClick.bind(this),this.e_InputKey=this.f_OnInputKey.bind(this),this.e_InputKeyUp=this.f_OnInputKeyUp.bind(this),this.e_InputPaste=this.f_OnInputKey.bind(this),this.el_Input.addEventListener("focus",this.e_InputFocus),this.el_Input.addEventListener("blur",this.e_InputBlur),this.el_Input.addEventListener("click",this.e_InputClick),this.el_Input.addEventListener("keydown",this.e_InputKey),this.el_Input.addEventListener("keyup",this.e_InputKeyUp),this.el_Input.addEventListener("paste",this.e_InputKey),this.p_Data=[],this.options.source!==undefined){f=this.options.source.substring(0,3);u=this.options.source.substring(4,this.options.source.length);switch(f){case"url":$.ajax({url:u,dataType:"json",success:function(n){var i={};i.value="";n.splice(0,0,i);t.p_Data=n}});break;case"var":e=window[u];t.p_Data=e}}else o=this.el_Element.querySelectorAll("li"),[].forEach.call(o,function(n){var i={};i[t.m_FieldItemKey]=n.getAttribute("key");i[t.m_FieldItemValue]=n.textContent;n.hasAttribute("onclick")&&(i.attr_onclick=n.getAttribute("onclick"));t.p_Data.push(i)});this.el_Input.hasAttribute("key")&&(i=this.el_Input.getAttribute("key"));this.f_InitMenu(this.p_Data);i!==undefined&&(this.el_Input.setAttribute("key",i),this.m_EnabledHiddensElements&&(this.el_ElementKey.value=i));this.m_TotalRows=this.p_Data.length;this.el_Input.hasAttribute(n.prototype.m_FieldItemKey)&&this.el_Input.getAttribute(n.prototype.m_FieldItemKey)!==""?this.f_SetKey(this.el_Input.getAttribute(n.prototype.m_FieldItemKey)):this.el_Input.value!=""&&this.f_SetValue(this.el_Input.value);this.f_CheckValidity()}};n.prototype.f_CheckValidity=function(){this.el_Input.validity&&(this.el_Input.validity.valid?this.el_Element.classList.remove(this.CssClasses_.IS_INVALID):this.el_Element.classList.add(this.CssClasses_.IS_INVALID))};n.prototype.f_SelectItem=function(n){var u=this,i=this.el_Menu.querySelectorAll("."+this.CssClasses_.MENU_ITEM),t=0,r;return([].forEach.call(i,function(i,r){if(i.classList.contains(u.CssClasses_.MENU_SELECT)&&(i.classList.remove(u.CssClasses_.MENU_SELECT),n!==undefined))return t=r+n,!1}),n!==undefined&&(i.length==t&&(t-=1),t>=0&&i.length>t&&(r=i[t],r!==undefined&&r!==null)))?(r.classList.add(this.CssClasses_.MENU_SELECT),!0):!1};n.prototype.f_AddItem=function(n,i){var r=this.f_GetItemValue(i),e,o,s,u,f;r===undefined?(r=i,e=o=n):(e=this.f_GetValue(i),o=Cl_Core.f_GetItemField(i,this.m_FieldItemKey));s="";i.attr_onclick!==undefined&&(s=' onclick="'+i.attr_onclick+'"');u='<li class="'+this.CssClasses_.MENU_ITEM+'" key="'+o+'" value="'+e+'"'+s+">";this.m_SearchText!==undefined&&this.m_SearchText!==null&&this.m_SearchText!==""?(f=r.toLowerCase().indexOf(this.m_SearchText.toLowerCase()),f>-1?(u+=r.substring(0,f),u+='<span class="mdl-menu__item_selectValue">'+r.substring(f,f+this.m_SearchText.length)+"<\/span>"+r.substring(f+this.m_SearchText.length)):u+=r):u+=r;u+="<\/li>";this.el_Menu.appendChild(t(u))};n.prototype.f_ClearItems=function(n){if(n!==undefined&&n){var t=this.el_Element.querySelectorAll("li");[].forEach.call(t,function(n){n.classList.add("hidden")})}else this.el_Menu.innerHTML="";this.el_Input.setAttribute("key","")};n.prototype.f_ShowItems=function(n){var t=this,i=this.el_Element.querySelectorAll("li");[].forEach.call(i,function(i){if(n!==undefined){var r=i.getAttribute("key");[].forEach.call(n,function(n){r===Cl_Core.f_GetItemField(n,t.m_FieldItemKey).toString()&&i.classList.remove("hidden")})}else i.classList.remove("hidden")})};n.prototype.f_InitMenu=function(n){var i=this,u,f,r,e;i.el_MenuContainer!=null&&i.el_MenuContainer.classList.remove(i.CssClasses_.IS_MENU_HIDE);u=function(n){var t,n,r;n||(n=window.event);n.which?t=n.which==3:n.button&&(t=n.button==2);t||(r=this.getAttribute("key"),i.f_SetKey(r),this.hasAttribute("onclick")&&Cl_Core.f_CalculateObjectValue(null,this.getAttribute("onclick"),[r],""),n.preventDefault())};f=function(n){i.f_MenuHide();n.preventDefault()};this.el_Input.setAttribute("key","");this.m_EnabledHiddensElements&&(this.el_ElementKey.value="");r=n;r===undefined&&(r=i.p_Data);r===undefined||r===null?i.p_Data=[]:(this.f_IsSearch()&&this.m_TotalRows!==undefined&&this.el_Menu.appendChild(t('<li class="'+this.CssClasses_.MENU_ITEM+' mdl-menu__item_title">Найдено: '+this.m_TotalRows+"<\/li>")),i.f_ClearItems(),[].forEach.call(r,function(n,t){i.f_AddItem(t,n)}),this.el_Element.style.width=r.length>0?this.el_Menu.clientWidth+(this.el_Menu.clientWidth<this.el_Menu.scrollHeight?17:0)+"px":this.el_Input.clientWidth!==undefined&&this.el_Input.clientWidth>10?this.el_Input.clientWidth+(this.el_Menu.clientWidth<this.el_Menu.scrollHeight?17:0)+"px":this.options.minWidth+"px",this.f_MenuHide(),this.options.readOnly&&this.f_SetValue());e=this.el_Element.querySelectorAll("li");[].forEach.call(e,function(n){n.removeEventListener("mousedown",u);n.addEventListener("mousedown",u,!1);n.removeEventListener("click",f);n.addEventListener("click",f,!1)});i.el_MenuContainer!=null&&i.el_MenuContainer.classList.add(i.CssClasses_.IS_MENU_HIDE)};n.prototype.f_SetDisabled=function(n){n&&!this.m_Disabled?(this.el_Element.classList.add(this.CssClasses_.IS_DISABLED),this.el_Element.hasAttribute("disabled")||this.el_Element.setAttribute("disabled",!0),this.el_Input.hasAttribute("disabled")||this.el_Input.setAttribute("disabled",!0),this.m_Disabled=!0):!n&&this.m_Disabled&&(this.el_Element.classList.remove(this.CssClasses_.IS_DISABLED),this.el_Element.hasAttribute("disabled")&&this.el_Element.removeAttribute("disabled"),this.el_Input.hasAttribute("disabled")&&this.el_Input.removeAttribute("disabled"),this.m_Disabled=!1)};n.prototype.f_ShowError=function(n){this.options.showError&&alert(n)};n.prototype.mdlDowngrade_=function(){this.el_Input.removeEventListener("focus",this.e_InputFocus);this.el_Input.removeEventListener("blur",this.e_InputBlur);this.el_Input.removeEventListener("click",this.e_InputClick);this.el_Input.removeEventListener("keydown",this.e_InputKey);this.el_Input.removeEventListener("keyup",this.e_InputKeyUp);this.el_Input.removeEventListener("paste",this.e_InputKey);componentHandler.downgradeElements(this.el_Menu)};n.prototype.mdlDowngrade=n.prototype.mdlDowngrade_;n.prototype.mdlDowngrade=n.prototype.mdlDowngrade;componentHandler.register({constructor:n,classAsString:"MaterialSelectfield",cssClass:"mdl-js-selectfield",widget:!0})})();